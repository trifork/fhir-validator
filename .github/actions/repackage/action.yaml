# This is a composite action that runs the validator

# This requires that a container with the fhir-validator is configured in
# the jobs.<job_id>.container.image field in the workflow file.
# See https://confluence.hl7.org/spaces/FHIR/pages/35718580/Using+the+FHIR+Validator#UsingtheFHIRValidator-PackageRegeneration for documentation
name: FHIR Validation CLI Repackager
description: Repackages a FHIR IG
inputs:

  fhir_ig_id:
    description: 'The FHIR IG id'
    required: true

  output:
    description: 'The output file name'
    required: true
  
  scope:
    description: 'which to include value sets etc from dependent IGs or core as well'
    required: false
    default: 'igs'

  mode:
    description: 'include the content conformance resources'
    required: false
    default: '-mode cnt -mode tx -mode api'

  pin:
    description: 'pinning versions. Use the value <-pin> for pinning.'
    required: false

  ignore_list:
    description: 'comma separated list of canonical urls to resources that will be removed in the final output'
    required: false

  include_list:
    description: 'comma separated list of canonical urls to resources that will be added to the final ouput'
    required: false

  include_conforms_to:
    description: 'boolean flag that will include any resources that are stated in any invariant using FHIR path conformsTo expression'
    required: false
  
  package_name:
    description: ""
    required: true

  version:
    description: "Version of FHIR"
    required: false
    default: "4.0.1"
  
  expansion_parameters:
    description: 'specifies the expansion parameters to use - this can supply fixed versions for code systems and value sets'
    required: false
    default: "../fsh-generated/resources/Parameters-expParam.json"

  command:
    description: 'The command to run the IG publisher'
    required: false
    default: 'java -jar /usr/local/bin/validator_cli.jar'

runs:
  using: 'composite'

  steps:
    - name: Run the FHIR Validation CLI Repackager
      run: ${{ inputs.command }} -re-package ${{ inputs.fhir_ig_id }} -output ${{ inputs.output }} -scope ${{ inputs.scope }} ${{ inputs.pin }} ${{ inputs.mode }} -package-name ${{ inputs.package_name }} -version ${{ inputs.version }} -expansion-parameters ${{ inputs.expansion_parameters }}
      shell: bash
